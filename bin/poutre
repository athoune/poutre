#!/usr/bin/env ruby

require "em-http-request"
require "em-http-metrics"
require "em-http-metrics/csv"
require "optparse"

concurrency = 20
duration = 0.5

optparse = OptionParser.new do |opts|
  opts.on('-c', '--concurrent C', Float, "Concurrents users") do |c|
    concurrency = c
  end
  opts.on('-d', '--duration D', Float, "Duration of the bench") do |d|
    duration = d
  end
end.parse!

url = ARGV[0]
puts "#{concurrency} clients during #{duration * 60} seconds will stress #{url}."

$run = true
def infinite_fetch url, wait=0
  conn = EventMachine::HttpRequest.new url
  http = conn.get
  http.errback do
    print "#"
    infinite_fetch url, wait if $run
  end
  http.callback do
    print "."
    infinite_fetch url, wait
  end
end

m = Metrics::Metrics.new
EM::HttpRequest.use EventMachine::Middleware::Metrics, m

EM.run do
  concurrency.to_i.times do
    infinite_fetch url
  end
  EM.add_timer(duration * 60) do
    $run = false
    EM.stop
    puts ""
    puts m.to_csv.string
    puts "#{m.length} requests"
    puts "#{m.length / (duration * 60)} query/seconds"
  end
end
